const fs = require("fs");
const jwt = require("jsonwebtoken");

// Load the RSA private key that will be used for signing (RS256)
const privateKey = `-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCtV2YoelkqU8K3
6AA3v8RMFBpafQmkWqgelFBNE1vm2AiConVPSI4XyXg8HopPtsRSrJMKehEgxmc1
fjeJdQLvbyvGUPX/17kpRfaglyhlkZURe3rJqaDqeD16j0MJU9FXJ92oCSTEtVU/
TszB503ys8ADXJkOp4ru3BPbK36jgVOg2ZaT5TJ+TeWaNHInwQfo0Zd7B4pf6d3E
6iFnvR69xNiJ6t5w89/1OY0w1c590mL+kLujacENnMv0E4qjYuwhT8kR31p3/n4C
wcojxMPWs6nAdPxj8qVYqQ8PA/WsTll6t8gJuvibA5Y/XAmspiLvQxRT9e1XrHzY
/jJLh5pFAgMBAAECggEAD6nyylYCa4FcLcaiPM3W2dHrO7tKCfcQDPHCe+SNWapM
XCzjRIHXwHogcLy8K03mjPRmHGLbD2CLM3NJAEisz9QpwYCcnXAlN3/IZ8sHbhfR
jHd7D6QerXFy8ZNM/H4wtmgc1WVvuoxxIqJm45LL7jjXpILtAqNmbTh0w7AF5pWc
2hc5xfglT1IehZ4GQDOBRRWbIIWbFPh4ZhlYeYl/hvFKs4POVtPYisyV5DPM+0qj
WYfnJ0z8Xa6iXsz+PuCcdXrNm1m4K7yQOjp8zHcK9CHIGWpTTMpVWd3Xl4INRYDk
TSXqkPR5PIXTRat05EHelg0l86Xe4/r6lgQBhp1h1QKBgQDg/JI2suhNoHBwwoq0
4KS/bYQSlSHCL/CG/vRrvBlaO/WXjPZ+AmWiVa8oIzkz+X87xgvsBxPDFjwppmFM
5f2CEpVpQrqAAn96Qfy4Yn640Kx/B2i//8kUmOEycEI4XhP/rAwHamarKz4ZzPKH
WrzEQ9Davh9yMnjkD39m+5jC5wKBgQDFPFlCWKTqJWnW0utE0d8juMKLEvF2OJY/
DTEjtvL5bIy1QqHWHLFRCfXcu4K8tKJ5Kd8DiPbPwx2lmsNkRzOyd8AGThIfQcX6
WxPEgFykNFgqJMt3zDVwKhx43wrYnlIiWo/beNaOFCT5pWFMLWUcLCUdvQ+qI8Nu
sVTmo7p/8wKBgHfsiS9Y29SM4YJpYDAb0hUrlgulrHHqxcXfXn+SqtzbOwSGIdl3
A5+tFolJhTM8GWLOJQqxlwoU7wqwYgrwSNmteDC8Xdbf/f038TKDZdKzgE7Rrzcw
a4lsGBWfmtya4QQWO+8z+vfgO+Dayqf1aMsg7tG6J97iImhGDn3hPEMfAoGBAI5t
FtOnKWd/nt8nLgdjOiwUdj9xbXX+RNjBEPQGX4ynyy/1LuJrk8u+UpGTwkO8ePrf
tpBZ7kh3UEhO6rvWAsnkWYD0DXgOygUQkcS7IKreta+xJFCc4RXfAvJxteZY5Vyz
YuCMcPrmJxEzUIBu422lnyPLa61j5/NeEL4AC2PrAoGBAIHfO6Kk4eWVb46+GL00
pbUS+42LdeI+kx5O/uU1/b2HKQhttaI0keXuuwnJuGgr2H+kW58Irdg/BlaGwIHs
0ac2xFDsgBk/zCvWAGyrf899v14Lo23/RrPm5S0qxYDj7VwHsytklf9gfHM9GAby
tXrsJulVZwRWFWv2AcwiPSJ5
-----END PRIVATE KEY-----`;


/**
 * Generate JWT token for a specific user role
 * @param {string} userRole - The user role (participant_admin, bank_admin, alice_user, bob_user)
 * @returns {string} Generated JWT token
 */

function generateToken(userRole) {
  // Create user-based JWT token for Canton's user management system
  // This references the users created in Canton (bank_admin, alice_user, bob_user)
  let payload = {
    scope: "daml_ledger_api", // Must match target-scope in config
    aud: "https://daml.com/jwt/aud/participant/participant1", // Must match target-audience in Canton config
    sub: userRole, // Subject is the user ID that exists in Canton
    iss: "canton-jwt-issuer", // Issuer identifier
    exp: Math.floor(Date.now() / 1000) + 365 * 24 * 60 * 60, // 1 year expiry
    iat: Math.floor(Date.now() / 1000), // Issued at
  };

  console.log(`Generating user-based token for Canton user: ${userRole}`);
  console.log(`Token will reference existing Canton user with ID: ${userRole}`);

  // Sign the JWT using the private key and RS256 algorithm
  // This creates a user-based token that references existing Canton users
  const token = jwt.sign(payload, privateKey, { algorithm: "RS256" });

  return token;
}

function generateMultiPartyToken(tokenName, parties) {
    // Create multi-party JWT token for operations like Transfer
    let payload = {
        scope: "daml_ledger_api",  // Must match target-scope in config
        aud: "https://daml.com/jwt/aud/participant/participant1",  // Must match target-audience in Canton config
        sub: tokenName,            // Subject is a descriptive name
        iss: "canton-jwt-issuer",  // Issuer identifier
        exp: Math.floor(Date.now() / 1000) + (365 * 24 * 60 * 60), // 1 year expiry
        iat: Math.floor(Date.now() / 1000),  // Issued at
        actAs: parties,            // Multiple parties that can act
        readAs: parties            // Same parties for read access
    };
 
    console.log(`Generating multi-party token: ${tokenName}`);
    console.log(`Parties included: ${parties.join(', ')}`);
 
    // Sign the JWT using the private key and RS256 algorithm
    const token = jwt.sign(payload, privateKey, { algorithm: 'RS256' });
    
    return token;
}

module.exports = {generateToken, generateMultiPartyToken};

